name: CI - Lint and Test

on:
  pull_request:
    branches: [ master ]
  # Removed push trigger to reduce noise - CI only runs on PRs
  # To manually trigger: use workflow_dispatch or push to PR branch

jobs:
  lint:
    name: Lint with Pylint
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      working-directory: ./denidin-app
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pylint
    
    - name: Run Pylint
      working-directory: ./denidin-app
      run: |
        # Fail on critical errors - threshold 7.0 for now
        # TODO: Separate task to achieve 10.0 by fixing all lint issues
        python -m pylint src/ \
          --fail-under=7.0 \
          --disable=C0303,C0305,R0914,R0917,R0912,R0915,W0611,W0707,W0719,C0411,W1514,C0325,W1309,C0301,W0612 \
          --max-line-length=120
    
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      working-directory: ./denidin-app
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run pytest
      working-directory: ./denidin-app
      run: |
        python -m pytest tests/ -v --tb=short
